 Initialized. View run at 
https://modal.com/apps/nikhilp0799/main/ap-Ak77eKtPED7BWP9VkKRSDI
 Created objects.
â”œâ”€â”€ Created mount 
â”‚   
â””â”€â”€ Created function train_ddp.

================================================================================
 PURE DDP: PREPARING MULTI-GPU TRAINING FOR MODAL
================================================================================
 Technique: DistributedDataParallel (PyTorch DDP)
 GPUs: 4Ã— H100
 Comparison: Will benchmark against FSDP
================================================================================

 Packaging code...
   - Adding tinyzero/
   - Adding setup.py
 Packaged 119,894 bytes (0.1 MB)

  Loading DDP config...
 Config loaded
   - DDP enabled: True
   - Backend: nccl
   - Batch size per GPU: 2
   - Num GPUs: 4
   - Gradient accumulation: 2
   - Effective batch size: 2 Ã— 4 Ã— 2 = 16

================================================================================
  READY TO LAUNCH ON MODAL
================================================================================
 Configuration:
   - GPUs: 4 Ã— H100
   - Backend: NCCL
   - CPUs: 32
   - RAM: 128 GB
   - Timeout: 4 hours
================================================================================

 Launching distributed training on Modal...
   (This will take several minutes to provision GPUs)

================================================================================
 TINYZERO: PURE DDP TRAINING (Multi-GPU)
================================================================================
 Technique: DistributedDataParallel (PyTorch DDP)
 GPUs: 4 Ã— H100
 Backend: NCCL (NVIDIA Collective Communications Library)
================================================================================

 Extracting code...
 Code extracted

  Writing DDP config...
 Config written

 Installing tinyzero package...
 Package installed

 Checking GPU availability...
CUDA available: True
GPU count: 4
GPU names: ['NVIDIA H100 80GB HBM3', 'NVIDIA H100 80GB HBM3', 'NVIDIA H100 80GB HBM3', 'NVIDIA H100 80GB HBM3']


 Setting up distributed environment...
 Environment configured

================================================================================
  STARTING DISTRIBUTED TRAINING
================================================================================

 Command: /usr/local/bin/python -m torch.distributed.run --nproc_per_node=4 --master_addr=localhost --master_port=29500 -m tinyzero.train_distributed --config configs/ddp_config.yaml
================================================================================
============================================================
 REWARDS MODULE LOADED - VERSION 3.0 WITH PROPER WEBSHOP REWARDS
============================================================
============================================================
 REWARDS MODULE LOADED - VERSION 3.0 WITH PROPER WEBSHOP REWARDS
============================================================
============================================================
 REWARDS MODULE LOADED - VERSION 3.0 WITH PROPER WEBSHOP REWARDS
============================================================
============================================================
 REWARDS MODULE LOADED - VERSION 3.0 WITH PROPER WEBSHOP REWARDS
============================================================
[Rank 3] Distributed training initialized: 4 GPUs
[Rank 2] Distributed training initialized: 4 GPUs
[Rank 1] Distributed training initialized: 4 GPUs
[Rank 0] Distributed training initialized: 4 GPUs

================================================================================
PURE DDP TRAINING (Multi-GPU)
================================================================================
Configuration:
  Technique: DistributedDataParallel (PyTorch DDP)
  GPUs: 4 Ã— H100
  Backend: NCCL
  Batch size per GPU: 2
  Effective batch size: 8
================================================================================

Loading models on rank 0...

[1AFetching 2 files:   0%|          | 0/2 [00:00<?, ?it/s]Fetching 2 files:   0%|          | 0/2 [00:00<?, ?it/s]
[1AFetching 2 files:   0%|          | 0/2 [00:00<?, ?it/s]
[1AFetching 2 files:   0%|          | 0/2 [00:00<?, ?it/s]Fetching 2 files:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:33<00:33, 33.34s/it]Fetching 2 files: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:33<00:00, 16.67s/it]
Fetching 2 files:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:33<00:33, 33.32s/it]Fetching 2 files: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:33<00:00, 16.66s/it]
Fetching 2 files:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:33<00:33, 33.36s/it]Fetching 2 files: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:33<00:00, 16.68s/it]
Fetching 2 files:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:33<00:33, 33.37s/it]Fetching 2 files: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:33<00:00, 16.68s/it]
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]
[1ALoading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]
[1ALoading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]
[1ALoading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 28.68it/s]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 28.76it/s]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 29.53it/s]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 29.25it/s]

[1ALoading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 28.27it/s]

[1ALoading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]
[1ALoading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 29.65it/s]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 29.49it/s]
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:00<00:00, 28.98it/s]
 V* cache initialized at ./vstar_cache
 V* caching enabled
 Adaptive V* sampling enabled
 V* cache initialized at ./vstar_cache
 V* caching enabled
 Adaptive V* sampling enabled
 V* cache initialized at ./vstar_cache
 V* caching enabled
 Adaptive V* sampling enabled
 V* cache initialized at ./vstar_cache
 V* caching enabled
 Adaptive V* sampling enabled
NCCL version 2.27.5+cuda12.9
[Rank 1] Policy model wrapped with DDP
  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
[Rank 0] Policy model wrapped with DDP
[Rank 0] Distributed trainer initialized
 Dataset loaded: 400 train, 50 eval

================================================================================
Epoch 1/2
================================================================================

  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
[Rank 3] Policy model wrapped with DDP
  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
[Rank 2] Policy model wrapped with DDP
  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.
Caching is incompatible with gradient checkpointing in Qwen2DecoderLayer. Setting `past_key_values=None`.
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.
Caching is incompatible with gradient checkpointing in Qwen2DecoderLayer. Setting `past_key_values=None`.
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.
Caching is incompatible with gradient checkpointing in Qwen2DecoderLayer. Setting `past_key_values=None`.
`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.
Caching is incompatible with gradient checkpointing in Qwen2DecoderLayer. Setting `past_key_values=None`.
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...

  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...  Generating samples for 2 uncached prompts...

  Generating samples for 2 uncached prompts...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...


  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...

  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
   V* cache: 2/2 hits (100.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...


  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
Step 5: Loss=6.0314 (CE=5.8750, KL=0.0000), Reward=0.000, Advantage=-0.634, V*=0.634
Step 5: Loss=6.0321 (CE=5.8540, KL=0.0002), Reward=0.000, Advantage=-0.788, V*=0.788
Step 5: Loss=5.1002 (CE=5.4607, KL=0.0002), Reward=0.000, Advantage=-0.711, V*=0.711
Step 5: Loss=5.7452 (CE=5.0497, KL=0.0002), Reward=0.500, Advantage=-0.346, V*=0.846
[Step 5] Loss: 5.7272, Reward: 0.125, V*: 0.745
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...  Generating samples for 2 uncached prompts...

  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...

  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...

  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 1 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
   V* cache: 1/2 hits (50.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...

  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 1 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
   V* cache: 1/2 hits (50.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...


  Generating samples for 2 uncached prompts...  Generating samples for 2 uncached prompts...

  Generating samples for 1 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
   V* cache: 1/2 hits (50.0% - saved compute!)
Step 10: Loss=5.6747 (CE=4.5000, KL=0.0000), Reward=0.000, Advantage=-0.600, V*=0.600
Step 10: Loss=4.8096 (CE=4.8095, KL=0.0000), Reward=0.000, Advantage=-0.412, V*=0.412
Step 10: Loss=4.1706 (CE=3.3750, KL=0.0001), Reward=0.000, Advantage=-0.846, V*=0.846
Step 10: Loss=3.3438 (CE=3.3438, KL=0.0000), Reward=0.000, Advantage=-0.412, V*=0.412
[Step 10] Loss: 4.4997, Reward: 0.000, V*: 0.567
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...

  Computing V* for 2 prompts (5 samples each)...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...

  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...

  Generating samples for 1 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 2/2 hits (100.0% - saved compute!)
   V* cache: 1/2 hits (50.0% - saved compute!)
   V* cache: 1/2 hits (50.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...



  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 1 uncached prompts...
  Generating samples for 1 uncached prompts...
   V* cache: 1/2 hits (50.0% - saved compute!)
   V* cache: 1/2 hits (50.0% - saved compute!)
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...
  Computing V* for 2 prompts (5 samples each)...  Computing V* for 2 prompts (5 samples each)...


  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
  Generating samples for 2 uncached prompts...
   V* cache: 2/2 hits (100.0% - saved compute!)
